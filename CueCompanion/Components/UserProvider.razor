@using BitzArt.Blazor.Cookies
@using CueCompanion.Services
@inject IJSRuntime JS
@inject AuthService Auth
@inject ICookieService Cookies
@rendermode InteractiveServer

<CascadingValue Value="this">
    @ChildContent
</CascadingValue>

@code {
    private bool _initialized;
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    public User? CurrentUser => Auth.User;
    
    protected override async Task OnInitializedAsync()
    {
        await Auth.StartAsync(Navigation.BaseUri);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            Auth.isLoading = true;

            string? key = await GetSessionKey();

            if (key != null)
            {
                await Connect(key);
            }

            Auth.isLoading = false;
            Auth.UpdateState();
        }
    }

    public async Task Logout()
    {
        _ = RemoveSessionKey();
        _ = Auth.ClearConnectionAsync();
    }

    public async Task<UserConnectionResult> Connect(string sessionKey)
    {
        UserConnectionResult result = await Auth.ConnectAsync(sessionKey);
        if (result.SessionKey != null)
        {
            await SetSessionKey(sessionKey);
        }

        if (result.User is { } user)
        {
            Permission[] permissions = await Auth.GetPermissionsForUserAsync();
            user.SetPermissions(permissions);
        }
        return result;
    }

    public async Task<UserConnectionResult> Connect(string username, string password)
    {
        UserConnectionResult result = await Auth.ConnectAsync(username, password);
        if (result.SessionKey != null)
        {
            await SetSessionKey(result.SessionKey);
            Permission[] permissions = await Auth.GetPermissionsForUserAsync();
            Auth.User?.SetPermissions(permissions);
        }

        return result;
    }

    public async Task<string?> GetSessionKey()
    {
        Cookie? cookie = await Cookies.GetAsync("sessionKey");
        return cookie?.Value;
    }

    public async Task SetSessionKey(string key)
    {
        Auth.SessionKey = key;
        await Cookies.SetAsync("sessionKey", key, DateTimeOffset.UtcNow.AddDays(1));
    }

    public async Task RemoveSessionKey()
    {
        await Cookies.RemoveAsync("sessionKey");
    }
}