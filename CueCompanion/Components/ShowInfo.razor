@inject AuthService Auth

<GridChild ColumnStart="3" ColumnEnd="4" RowStart="2" RowEnd="3">
    <MudText Typo="Typo.h1">Show Info</MudText>
    @if (ShowService?.CurrentShow is { } show)
    {
        <EditableText @bind-Value="show.Name" IsEditMode="IsEditMode" OnValueChanged="ShowNameChanged"/>
        <MudText Typo="Typo.subtitle2">Show ID: @show.Id</MudText>

        <MudText Typo="Typo.body1">
            <br/>
            @show.Description
            <br/>
            @show.Notes
            <br/>
        </MudText>

        <MudDivider/>
        <MudText Typo="Typo.body1">Date: @show.Start.Date.ToShortDateString()</MudText>
        <MudText Typo="Typo.body1">Start time: @show.Start.ToLongTimeString()</MudText>
        <MudText Typo="Typo.body1">End time: @show.End.ToLongTimeString()</MudText>
        <MudDivider/>
        <MudText Typo="Typo.body1">Active: @(ShowService.CurrentCuePosition == null ? "False" : "True")</MudText>
        <MudText Typo="Typo.body1">Number of Cues: @ShowService.CurrentCues.Length</MudText>
    }
    else
    {
        <MudText>No show loaded</MudText>
    }
</GridChild>

@code
{
    [CascadingParameter]
    public ShowService? ShowService { get; set; }

    [CascadingParameter(Name = "IsEditMode")]
    public bool IsEditMode { get; set; }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        ShowService?.OnStateChanged += ShowInfoChanged;
        return Task.CompletedTask;
    }

    private void ShowInfoChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task ShowNameChanged(string newName)
    {
        if (ShowService?.CurrentShow is { } show && Auth.SessionKey is { } key)
        {
            show.Name = newName;
            await ShowService.UpdateShowAsync(key);
        }
    }
}
