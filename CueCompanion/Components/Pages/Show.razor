@page "/show"

@inject ShowService ShowService
@inject AuthService Auth
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <CascadingValue Value="ShowService">
        <GridContainer AutoVertical="true">
            <CueExplorer/>
            <CurrentCue/>
            <CueNotes/>
            <ShowInfo/>
        </GridContainer>
    </CascadingValue>
</MudContainer>


@code
{
    [CascadingParameter]
    public UserProvider? UserProvider { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ShowService.OnStateChanged += () => InvokeAsync(StateHasChanged);
        Auth.OnStateChanged += () => InvokeAsync(StateHasChanged);
        UserProvider?.OnStateChanged += () => InvokeAsync(FetchShowInfo);

        await ShowService.StartAsync(Navigation.BaseUri);
        await FetchShowInfo();
        ShowService.UpdateState();
    }

    private async Task FetchShowInfo()
    {
        if (Auth.SessionKey is { } key)
        {
            ShowRequestResult result = await ShowService.GetCurrentShowAsync(key);
            if (!result.Success)
            {
                await DialogService.ShowAsync<ErrorDialog>("Login failed", new DialogParameters<ErrorDialog>
                {
                    { x => x.Title, "Getting show failed" },
                    { x => x.Text, result.ErrorMessage }
                }, new DialogOptions { CloseOnEscapeKey = true });
            }

            if (result.Success && result.Show is { } show)
            {
                CueRequestResult cueResult = await ShowService.GetCuesForShowAsync(key, show.Id);
            }
            StateHasChanged();
        }
    }
}
