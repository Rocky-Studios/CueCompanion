@page "/show"

@inject ShowService ShowService
@inject AuthService Auth
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <CascadingValue Value="ShowService">
        <CascadingValue Name="IsEditMode" Value="isEditMode">
            <GridContainer AutoVertical="true">
                <CueExplorer/>
                <CurrentCue/>
                <CueNotes/>
                <ShowInfo/>
            </GridContainer>
        </CascadingValue>
    </CascadingValue>
</MudContainer>
@if (HasEditPermissions)
{
    <MudButton OnClick="ToggleEditMode"
               Class="edit-mode-button"
               Variant="Variant.Filled"
               Color="@editButtonColor"
               StartIcon="@Icons.Material.Filled.Edit"
               Size="Size.Small">
        Edit
    </MudButton>
}

@code
{

    public bool HasEditPermissions
    {
        get
        {
            if (!Auth.PermissionsCache.TryGetValue("EditShow", out int _)) return false;
            return UserProvider?.CurrentUser?.HasPermission(Auth.PermissionsCache["EditShow"]) ?? false;
        }
    }

    [CascadingParameter]
    public UserProvider? UserProvider { get; set; }

    private bool isEditMode;
    private Color editButtonColor => isEditMode ? Color.Primary : Color.Default;

    protected override async Task OnInitializedAsync()
    {
        ShowService.OnStateChanged += () => InvokeAsync(StateHasChanged);
        Auth.OnStateChanged += () => InvokeAsync(StateHasChanged);
        UserProvider?.OnStateChanged += () => InvokeAsync(FetchShowInfo);

        await ShowService.StartAsync(Navigation.BaseUri);
        await FetchShowInfo();
        ShowService.UpdateState();
    }

    private async Task FetchShowInfo()
    {
        if (Auth.SessionKey is { } key)
        {
            ShowRequestResult result = await ShowService.GetCurrentShowAsync(key);
            if (!result.Success)
            {
                await DialogService.ShowAsync<ErrorDialog>("Login failed", new DialogParameters<ErrorDialog>
                {
                    { x => x.Title, "Getting show failed" },
                    { x => x.Text, result.ErrorMessage }
                }, new DialogOptions { CloseOnEscapeKey = true });
            }

            if (result.Success && result.Show is { } show)
            {
                CueRequestResult cueResult = await ShowService.GetCuesForShowAsync(key, show.Id);
            }
            StateHasChanged();
        }
    }

    private void ToggleEditMode()
    {
        isEditMode = !isEditMode;
        StateHasChanged();
    }
}
