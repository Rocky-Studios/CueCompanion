@page "/"
@using System.Text.RegularExpressions
@using MudBlazor
@inject IJSRuntime JS
@inject AuthService Auth

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudText Typo="Typo.h1">Dashboard</MudText>
    <div class="d-flex flex-row justify-content-center align-items-center">
        <Login></Login>
    </div>
</MudContainer>

@code
{
    private bool _initialized = false;

    protected override async Task OnInitializedAsync()
    {
        await Auth.StartAsync(Navigation.BaseUri);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            Auth.isLoading = true;

            string? key = null;
            string cookie = await JS.InvokeAsync<string>("eval", "document.cookie") ?? string.Empty;
            Match m = Regex.Match(cookie, @"(?:^|; )sessionKey=([^;]*)");
            if (m.Success)
            {
                key = Uri.UnescapeDataString(m.Groups[1].Value);
            }

            if (key != null)
            {
                await Auth.ConnectAsync(key);
            }

            Auth.isLoading = false;
            Auth.UpdateState();
        }
    }
}