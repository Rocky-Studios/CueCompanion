@page "/editor"
@using System.Text.Json
@rendermode InteractiveAuto
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>CueCompanion - Show Editor</PageTitle>
<h1>Show Editor</h1>
<div class="main-view">
    <div class="main-box cue-explorer">
        <h3>Cue Explorer</h3>
        <div class="cue-explorer-container">
            <table class="cue-explorer-controls">
                <tr>
                    <td colspan="2">Change</td>
                    <td colspan="3">
                        <button>Prev</button>
                    </td>
                    <td colspan="3">
                        <button>Next</button>
                    </td>
                </tr>
            </table>
            <div class="cue-explorer-cues">
                <div class="cue-explorer-list">
                    @foreach (Cue cue in CurrentShow.Cues)
                    {
                        string cueColor = cue.CueNumber == CurrentCueNumber ? "Green"
                            : cue.CueNumber == CurrentCueNumber - 1 ? "Yellow"
                            : cue.CueNumber == CurrentCueNumber + 1 ? "Blue"
                            : "Gray";
                        <CueBox Name="@cue.CueName" Number="@cue.CueNumber" Color="@cueColor"/>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="main-box current-cue">
        <h3>Current Cue - @CurrentCue?.CueName (@CurrentCueNumber)</h3>
        <div style="min-height: 20vh" class="thin-border">
            <h3>Tasks</h3>

        </div>
        <div class="cue-notes thin-border">
            <h3>Notes</h3>

        </div>
    </div>
    <div class="main-box info">
        <h3>Info</h3>
        <div class="show-info-details thin-border">
            <h5>Show:</h5>
            <p>Name <input @bind="CurrentShow.Name"/></p>
            <p>Date: <input type="date" @bind="CurrentShow.Date"/></p>
            <p>Start time: <input type="time" @bind="CurrentShow.StartTime"/></p>
            <p>End time: <input type="time" @bind="CurrentShow.EndTime"/></p>
            <p>Location:
                <select @bind="CurrentShow.Location">
                    <option>MPC</option>
                    <option>Piazza</option>
                </select>
            </p>
            <br/>
            <h5>Total Cues:</h5>
            <p>@CurrentShow.Cues.Length</p>
            <br/>
            <h5>Roles:</h5>
            <button @onclick="AddNewRole">Add new role</button>
            <ul>
                @foreach (Role role in CurrentShow.Roles)
                {
                    if (role.PersonName != "")
                    {
                        <li><input @bind="role.RoleName"/> - <input @bind="role.PersonName"/>
                            <button
                                @onclick="() => RemoveRole(role)">
                                ‚ùå
                            </button>
                        </li>
                    }
                    else
                    {
                        <li>@role.RoleName</li>
                    }
                }
            </ul>
            <br/>
            <button @onclick="ImportShowFromJson">Import</button>
            <button @onclick="ExportShowToJson">Export</button>
        </div>
    </div>

    <script>
        window.downloadFileFromStream = async (fileName, contentStreamReference) => {
            const arrayBuffer = await contentStreamReference.arrayBuffer();
            const blob = new Blob([arrayBuffer]);
            const url = URL.createObjectURL(blob);
            const anchorElement = document.createElement('a');
            anchorElement.href = url;
            anchorElement.download = fileName ?? '';
            anchorElement.click();
            anchorElement.remove();
            URL.revokeObjectURL(url);
        }

        window.selectImportJsonFile = async () => {
            return new Promise((resolve, reject) => {

                const inputElement = document.createElement('input');
                inputElement.type = 'file';
                inputElement.accept = '.json';

                if (!inputElement) {
                    reject("Input element not found");
                    return;
                }

                inputElement.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) {
                        reject("No file selected");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    reader.onerror = (e) => {
                        reject("Error reading file");
                    };
                    reader.readAsText(file);
                });

                inputElement.click();
            });
        }

        window.addEventListener("beforeunload", function (e) {
            var confirmationMessage = 'Before closing this page, please make sure to export your show to avoid losing any changes.';

            (e || window.event).returnValue = confirmationMessage; //Gecko + IE
            return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
        });
    </script>

</div>

@code
{
    private Show CurrentShow { get; set; } = Show.CreateDefault();
    private int CurrentCueNumber { get; } = 0;
    private Cue? CurrentCue => CurrentShow.Cues.FirstOrDefault(c => c?.CueNumber == CurrentCueNumber);

    private async Task ExportShowToJson()
    {
        string json = JsonSerializer.Serialize(CurrentShow);
        Stream fileStream = new MemoryStream();
        StreamWriter writer = new(fileStream);
        await writer.WriteAsync(json);
        await writer.FlushAsync();
        fileStream.Position = 0;
        string fileName = "ShowExport_" + CurrentShow.Name.Replace(" ", "_") + ".json";

        using DotNetStreamReference streamRef = new(fileStream);

        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task ImportShowFromJson()
    {
        string json = await JS.InvokeAsync<string>("selectImportJsonFile");
        CurrentShow = JsonSerializer.Deserialize<Show>(json);
    }

    private async Task AddNewRole()
    {
        CurrentShow.Roles = CurrentShow.Roles.Append(new Role("New Role", "New Person")).ToArray();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RemoveRole(Role role)
    {
        List<Role> rolesList = CurrentShow.Roles.ToList();
        rolesList.Remove(role);
        CurrentShow.Roles = rolesList.ToArray();
        await InvokeAsync(StateHasChanged);
    }
}
