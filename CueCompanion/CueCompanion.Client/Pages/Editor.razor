@page "/editor"
@using System.Text.Json
@rendermode InteractiveAuto
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject CounterService Counter

<PageTitle>CueCompanion - Show Editor</PageTitle>
<h1>Show Editor</h1>
<div class="main-view">
    <div class="main-box cue-explorer">
        <h3>Cue Explorer</h3>
        <div class="cue-explorer-container">
            <table class="cue-explorer-controls">
                <tr>
                    <td colspan="2">Change</td>
                    <td colspan="3">
                        <button>Prev</button>
                    </td>
                    <td colspan="3">
                        <button>Next</button>
                    </td>
                </tr>
            </table>
            <div class="cue-explorer-cues">
                <div class="cue-explorer-list">
                    @foreach (Cue cue in CurrentShow.Cues)
                    {
                        string cueColor = cue.CueNumber == Counter.State.CurrentCueNumber ? "Green"
                            : cue.CueNumber == Counter.State.CurrentCueNumber - 1 ? "Yellow"
                            : cue.CueNumber == Counter.State.CurrentCueNumber + 1 ? "Blue"
                            : "Gray";
                        <CueBox Name="@cue.CueName" Number="@cue.CueNumber" Color="@cueColor"/>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="main-box current-cue">
        <h3>Current Cue - @CurrentCue?.CueName (@Counter.State.CurrentCueNumber)</h3>
        <div style="min-height: 20vh" class="thin-border">
            <h3>Tasks</h3>

        </div>
        <div class="cue-notes thin-border">
            <h3>Notes</h3>

        </div>
    </div>
    <div class="main-box info">
        <h3>Info</h3>
        <div class="show-info-details thin-border">
            <h5>Show:</h5>
            <p>@CurrentShow.Name</p>
            <p>Date: @CurrentShow.Date.ToShortDateString()</p>
            <p>Time: @CurrentShow.StartTime.ToShortTimeString() - @CurrentShow.EndTime.ToShortTimeString()</p>
            <p>At: @CurrentShow.Location.ToString()</p>
            <br/>
            <h5>Total Cues:</h5>
            <p>@CurrentShow.Cues.Length</p>
            <br/>
            <h5>Roles:</h5>
            <ul>
                @foreach (Role role in CurrentShow.Roles)
                {
                    if (role.PersonName != "")
                    {
                        <li>@role.RoleName - @role.PersonName</li>
                    }
                    else
                    {
                        <li>@role.RoleName</li>
                    }
                }
            </ul>
            <br/>
            <button @onclick="ExportShowToJson">Export</button>
        </div>
    </div>

    <script>
        window.downloadFileFromStream = async (fileName, contentStreamReference) => {
            const arrayBuffer = await contentStreamReference.arrayBuffer();
            const blob = new Blob([arrayBuffer]);
            const url = URL.createObjectURL(blob);
            const anchorElement = document.createElement('a');
            anchorElement.href = url;
            anchorElement.download = fileName ?? '';
            anchorElement.click();
            anchorElement.remove();
            URL.revokeObjectURL(url);
        }
    </script>

</div>

@code
{
    Show CurrentShow => Counter.State.CurrentShow;
    Cue? CurrentCue => CurrentShow.Cues.FirstOrDefault(c => c?.CueNumber == Counter.State.CurrentCueNumber, null);

    private async Task ExportShowToJson()
    {
        string json = JsonSerializer.Serialize(CurrentShow);
        Stream fileStream = new MemoryStream();
        StreamWriter writer = new(fileStream);
        await writer.WriteAsync(json);
        await writer.FlushAsync();
        fileStream.Position = 0;
        string fileName = "ShowExport_" + CurrentShow.Name.Replace(" ", "_") + ".json";

        using DotNetStreamReference streamRef = new(fileStream);

        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
