@page "/show"
@using System.Text.Json
@using CueCompanion.Client.Components
@rendermode InteractiveAuto
@inject NavigationManager Navigation
@inject IJSRuntime JS
<PageTitle>CueCompanion</PageTitle>
<FlexContainer>
    <FlexItem>
        <CueExplorer Cues="CurrentShow?.Cues"/>
    </FlexItem>
    <FlexItem>
        <CueDetails/>
    </FlexItem>
    <FlexItem>
        <MudPaper Class="p-4" Outlined="true">
            <MudText Typo="Typo.h5">Connection</MudText>
            <ConnectionStatus/>
        </MudPaper>
    </FlexItem>
</FlexContainer>

@code {
    protected CueCompanion.Show? CurrentShow => ShowService.Show;
    protected Cue? CurrentCue => ShowService.CurrentCue;
    protected string[]? TasksForCurrentCue => CurrentCue?.Tasks.Values.ToArray();
    protected Dictionary<string, bool>? RoleViewStates { get; set; } = new();
    protected int? CurrentCueNumber => ShowService.CurrentCueNumber;
    protected string? AllNotes;

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnChange += StateChanged;
        ShowService.OnChange += StateChanged;

        Task.Run(async () =>
        {
            await ShowService.StartAsync(Navigation.BaseUri);
            await AuthService.StartAsync(Navigation.BaseUri);

            string? secret = await LocalStorage.GetItemAsync("connectionSecret");
            Guid? secretGuid = secret != null ? Guid.Parse(secret) : null;
            string? connectionName = await LocalStorage.GetItemAsync("connectionName");
            string? connectionPasskey = await LocalStorage.GetItemAsync("connectionPasskey");
            if (connectionName != null && connectionPasskey != null)
            {
                await AuthService.Connect(connectionName, connectionPasskey, secretGuid);
                if (AuthService.Connection != null)
                {
                    await LocalStorage.SetItemAsync("connectionName", AuthService.Connection.ConnectionName);
                    await LocalStorage.SetItemAsync("connectionPasskey", AuthService.Connection.ConnectionPasskey);
                    if (AuthService.Connection.Secret is { } connectionSecret)
                        await LocalStorage.SetItemAsync("connectionSecret", connectionSecret.ToString());
                }
            }

            await StateChanged();
        });
    }

    async Task StateChanged()
    {
        await ShowService.GetShow();
        await InvokeAsync(StateHasChanged);
    }

    private async Task IncrementCueNumber()
    {
    }

    private async Task DecrementCueNumber()
    {
    }

    private async Task ImportShowFromJson()
    {
        if (ShowService.State == null) return;
        string json = await JS.InvokeAsync<string>("selectImportJsonFile");
        ShowService.State.CurrentShow = JsonSerializer.Deserialize<CueCompanion.Show>(json) ?? ShowService.State.CurrentShow;
        //await ShowService.UpdateEntireState();
    }
}
