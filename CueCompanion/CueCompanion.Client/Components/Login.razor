@using System.ComponentModel.DataAnnotations
@inject IDialogService DialogService
<MudPaper MaxWidth="30%">
    <MudText Typo="Typo.h2">Login</MudText>
    <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator/>
        <MudTextField Label="Connection" Class="mt-3" @bind-Value="model.ConnectionName"
                      For="@(() => model.ConnectionName)" InputType="InputType.Text"/>
        <MudTextField Label="Password" Class="mt-3" @bind-Value="model.Password" For="@(() => model.Password)"
                      InputType="InputType.Password"/>

        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto mt-2">
            Login
        </MudButton>
    </EditForm>

</MudPaper>
<MudDialogProvider>
</MudDialogProvider>

@code {
    readonly LoginForm model = new();
    bool success;

    public class LoginForm
    {
        [Required] public string ConnectionName { get; set; }

        [Required]
        public string Password { get; set; }
    }

    protected override void OnInitialized()
    {
        Auth.OnStateChanged += StateHasChanged;
    }

    private void OnValidSubmit(EditContext context)
    {
        success = true;
        Task.Run(async () =>
        {
            ConnectionResult result = await Auth.ConnectAsync(model.ConnectionName, model.Password);
            if (result.ErrorMessage is { } error)
            {
                DialogOptions options = new() { CloseOnEscapeKey = true };
                DialogParameters<ErrorDialog> parameters = new()
                {
                    { x => x.ContentText, error }
                };
                DialogService.ShowAsync<ErrorDialog>("Login failed", parameters, options);
            }
        });
    }

}